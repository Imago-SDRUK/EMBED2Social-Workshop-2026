---
format:
  revealjs:
    theme: assets/imago.scss
    navigation-mode: linear
    controls-layout: 'bottom-right'
_notes: |
  <!-- style guide -->

  ## {.light}

  Blah blah

  This is [important]{.orange} and this is [a link concept]{.green}.

  Or mix: [navy]{.navy}, [blue]{.blue}, [green]{.green}, [orange]{.orange}

  ## {.dark}

  Blah blah 

  This is [important]{.orange} and this is [a link concept]{.green}.

  Or mix: [navy]{.navy}, [blue]{.blue}, [green]{.green}, [orange]{.orange}
---

## _Lab 1_ {.title-slide .light}

### _Exploring geo-embeddings in the real world_ {.subtitle}

**Vitaly Kryukov, Newcastle University**


![](assets/figures/lab1_data_cube.png){ width=130% fig-alt="Geospatial cube" fig-align="center" }

--- 

## We have more data than ever!<br>Mo Data, Mo Problems?

<!-- (2min), Intro based on Lecture 1 -->

<!--To reiterate that sometimes too many datasets, too much documentation and too much time required to figure out what is what in datasets.
Again, embeddings is a one of the most comprehensive and explicit efforts to integrate many datasets for the human use
-->

![](assets/figures/lab1_diagram_datasets.png){ width=70% fig-alt="Diagram of datasets" fig-align="center" }



# Google Satellite Embeddings: context <!-- (8min) -->

## Google Earth Engine
<a href="https://developers.google.com/earth-engine/datasets/catalog/GOOGLE_SATELLITE_EMBEDDING_V1_ANNUAL" 
   class="url" 
   style="font-size: 0.8em;">
https://developers.google.com/earth-engine/datasets/catalog/GOOGLE_SATELLITE_EMBEDDING_V1_ANNUAL
</a>

![](assets/figures/lab1_embed_visual3bands_1.png){ width=70% fig-align="center" }
<br>*RGB for bands 1,2,3*

![](assets/figures/lab1_embed_visual3bands_2.png){ width=70% fig-align="center" }
<br>*RGB for random bands*

::: {.notes}
    Illustrate only three first bands for the sake of sanity  and to keep things simple and clear. We can't illustrate all the bands
    Open a console with a pre-filled script to show the available Google Embeddings for the area of interest (London)
:::

## Multiple dimensions


::: {.columns}

::: {.column width="65%"}
![](assets/figures/lab1_2024_TQ28-2024_buildings_rdbu.gif)

:::

::: {.column width="35%"}
Dimensions are [interlinked]{.orange} and create a 'semantical map' altogether,<br>
<br>
but even a few may tell a story...

:::

:::
<!--“Every dimension matters, but a few are enough to get started.” “All bands together create the semantic map; some bands already tell the story.”-->


## IMAGO pipeline

<img src="assets/figures/lab1_pipeline.png" alt="Description" />

<!--
- Snippet of annual (2024) Embedding dataset in QGIS. 
Go through the main specification of the dataset:
64 bands, values magnitude, data type, CRS, compression, width x height, spatial resolution (pixel size).
Highlight CRS is different by default from what we've used to work for spatial math (projected CRS),
so reprojection was implemented in the Imago product internally in GEE. Reprojection could be also defined in Google Earth
Size issue (this dataset contains 64 bands, so it becomes difficult to store them)
Illustrate only three first bands for the sake of sanity  and to keep things simple and clear.

The visualisation is more a semantic map, not a geographical map anymore! 
We can use only a subset of bands with caution, for visual comparisons and initial analysis, not for the final production and research
-->

## IMAGO data product

<!--In Imago, we do not limit ourselves with satellite rasters. We go beyond and find out how 
the satellite imagery can be useful to social science.

Super output areas 
Lower layer Super Output areas - small statistical units 
Additional analytical data are available - population, deprivation, property counts, census, demographic profiles
Other scientific data records available if they are built on LSOA basis-->

<img src="assets/figures/lab1_lsoa_multidim.png" alt="Description" />

## Annual changes
[65th dimension]{.orange}

<img src="assets/figures/lab1_lsoas_dynamics.png" alt="Description" />

<!--## Final data product

Imago Data Catalogue: product for London (but UK will be made available) with complete metadata
Can be freely downloaded for non-commercial usage (?), but sign up is required

GPKG format, which repeats LSOA polygons with their original ID, but also adds 64 extra attributes (columns)
Mean value of each embedding aggregated over the LSOA area
Projected CRS

Technical report with accuracy tests and details in development, but will be made open on Github in a public repo.-->


# Moving to GIS exercises <!-- (10-15min) -->

## Exercise 1. LSOA exploration
<!-- General Embedding exploration at LSOA scale -->

Imago Data Product: <a href="https://data.imago.ac.uk/datasets/google-satellite-embedding-v1-london-lsoas-2020-2024" target="_blank">
  https://data.imago.ac.uk/datasets/google-satellite-embedding-v1-london-lsoas-2020-2024
  </a>

### Steps

::: {.columns}

::: {.column width="70%"}
<div style="font-size: 0.8em;">
1. Download two GeoPackage files (2020 and 2024), open 2024
2. Explore `Layer Properties` - CRS, format, fields, field types
3. Create a layer style to illustrate the spatial differences for the `A00_mean` column: <br>
[Symbology → Layer Properties → Graduated → Default mode → 20 classes → Histogram]{.orange}
</div>
::: 

::: {.column width="30%"}
![](assets/figures/lab1_exercise1_screen0.png){ width=65% fig-alt="Screenshot" fig-align="left" }
:::
----

4. Repeat for the second and third bands (`A01_mean` and `A02_mean`)
5. Do you see any visual difference?


----

### Steps
6. Visualise layer with 50% transparency over OSM or Google Satellite background.
To find the background, use the `QuickMapServices` plugin 

::: {layout-ncol=2}
![](assets/figures/lab1_exercise1_screen0.jpg){width=60%}
:::

----

7. Find an outskirt LSOA and Westminster LSOA: <br>
`Processing Toolbox -> Select by expression -> Expression:` <br>
["data_zone_code" IN ('E01002292', 'E01004690')]{.orange}

How different are they?

---

![](assets/figures/lab1_exercise1_screen1.png){ width=100% fig-alt="screenshot" fig-align="left" }

<!-- Although values across bands differ a lot, in general each band shows some spatial differences and relations between 
spatial features and land use/land cover types. Illustration of a GeoTIFF tile (Multiband colour) which will show general
land use/land cover features.-->

----

## Exercise 2. Is London dynamic? <!-- (15-20min) -->

[65th dimension]{.orange} is back - time

<!-- Embeddings are widely used for many purposes, especially to analyse spatial changes in time.
Our data product contains Embeddings already aggregated at the level of LSOA for a timeframe of five years (2020-2024).
What if the local authorities need an explicit information on how rapidly their areas have been changing?
It's not too difficult with this data product-->

-----

## Steps
1. Ensure you have Embeddings-LSOA for two timeframes (2020 and 2024)
2. Tick on both layers, choose a random LSOA and click `Identify features`. Then click `Identify all`.
3. Do you see 64 mean embedding values for this feature?


-----

::: {.columns}

::: {.column width="40%"}
4. Compare visually the values in the first three columns for 2020 and 2024:  
`A00_mean`, `A01_mean`, `A02_mean`.  

Do they differ a lot?
:::

::: {.column width="60%"}
![](assets/figures/lab1_exercise2_screen0.png){ width=100% fig-alt="Geospatial cube" fig-align="center" }
:::

:::



----

::: {.columns}

::: {.column width="35%"}
5. Let's move to numbers!  

- Use [Processing Toolbox → Vector general → Join attributes by field value]{.orange}

- Join `2020` layer to `2024`

- Define joined field prefix - `2020_`

:::

::: {.column width="65%"}
![](assets/figures/lab1_exercise2_screen1.png){ width=100% fig-alt="Geospatial cube" fig-align="center" }
:::

:::

-----

::: {.columns}

::: {.column width="45%"}
6. In the output dataset:
- open [Field Calculator]{.orange}
- calculate the difference between 2024 and 2020 for the `A02_mean` dimension: <br>
["A02_mean" - "2020_A02_mean"]{.orange} <br>
- choose output field type: <br>
[Decimal number (real)]{.orange}



:::

::: {.column width="55%"}
![](assets/figures/lab1_exercise2_screen2.png){ width=100% fig-alt="Geospatial cube" fig-align="center" }
:::

:::

----

::: {.columns}

::: {.column width="50%"}

7. Let’s visualise:

- Layer Properties → Symbology → Graduated  
- In `value` field choose the last column  
- Colour ramp -> `RdBu`
- Mode -> Equal interval  
- Symmetric classification -> Around 0  
- Classes - 10
- Classify  
- Check out `histogram`
:::

::: {.column width="50%"}
![](assets/figures/lab1_exercise2_screen3.png){ width=150% fig-alt="Geospatial cube" fig-align="left" }
:::

:::

----

8. Do you see any trends in London?

![](assets/figures/lab1_exercise2_screen4.png){ width=150% fig-alt="Geospatial cube" fig-align="left" }

<small>
A02 dimension
</small>

<!-- In this dimension (A00), the centre and outskirts change in a different way
Does it confirm 'urban sprawl or 'gentrification'? Not really, it's only one band!
-->



-----

## (Optional)
<!-- This part is pre-analysed and output will be shared on the screen anyway. Sharing the steps and then the result -->

9. Let's calculate the difference for other dimensions!
10. Repeat the steps for dimension `A03_mean`

![](assets/figures/lab1_exercise2_screen5.png){ width=150% fig-alt="Geospatial cube" fig-align="left" }

<small>
A03 dimension
</small>

----

## Exercise 3. Near or Far?
<!-- (15min) -->


------

### Similarity search: steps

1. Choose GeoJSON files from the data bundle (2020 and 2024) <br>
2. Go to <a href="https://imago-similarity.com" target="_blank">
  https://imago-similarity.com **[PENDING]**
  </a> <br>(Chrome recommended)
3. Upload the Embedding-LSOA dataset (2020) in GeoJSON format
4. Pick your area and find what is the most similar one?

---------

![](assets/figures/lab1_exercise3_screen1.png){ width=100% fig-alt="Geospatial cube" fig-align="left" }

---------

5. Let's find more similar areas...
6. What about the least similar? 
7. Now upload the Embedding-LSOA dataset from 2024 
8. Do you spot differences in similar places?

![](assets/figures/lab1_exercise3_screen2.png){ width=100% fig-alt="Geospatial cube" fig-align="left" }

----

### Results
Did something surprise you?
<!-- Similarity of areas with different use (industrial, residential, natural)
- Multi-functional areas -->

![](assets/figures/lab1_exercise3_screen3.png){ width=100% fig-alt="Geospatial cube" fig-align="left" }

---

## Exercise 4. London in Motion <!-- (15min) -->

Any prominent examples of land use or land cover changes in London (2020-2024)? <br>
Web, AI, your memory - everything works!
<!-- You probably know some prominent examples of land use or land cover changes in London. 
It might be a new notoriously known apartment complex, motorway extension, or simply speaking, introduction of human-made infrastructure.

Or it might be another process where the city introduces semi-natural or quasi-natural objects, for example 
revitalizes industrial areas into urban gardens and parks. -->

::: {.columns}

::: {.column width="50%"}
<img src="assets/figures/lab1_earls-court-buildings.jpg" alt="development" style="max-width:100%;" />
<br>
<small>
Earl's Court development <br>
(<a href="https://londonist.com/london/latest-news/what-s-happening-with-the-earl-s-court-development" target="_blank">
https://londonist.com/london/latest-news/what-s-happening-with-the-earl-s-court-development 
</a>)
</small>
:::

::: {.column width="50%"}
<img src="assets/figures/lab1_case_study_location.png" alt="development" style="max-width:80%;" />
:::

:::
----

### Steps

1. Ensure you have Embeddings-LSOA data in QGIS for 2020 and 2024
2. Find a catchy example of [land use/land cover change]{.orange} in London (2020-2024)
3. Spot the location. Which LSOA(s) does it cover?
4. Do Embedding follow the 2020-2024 change? <br>You can explore multiple dimensions...

---

5. Share your results!
<img src="assets/figures/lab1_building_dynamics.png" alt="development" style="max-width:100%;" />

----

## [EXTRA] Exercise 5. 'Ground' Embeddings <!-- (15min) -->

Embedding might seem as a quite abstract thing...

Let's ground it!

[Do Embeddings really 'feel' other data?]{.orange}

<!--  Some relation between embed values and population density from ONS - TODO 
There is some correlation (0.4-0.6) for some bands and population density, 
while other bands don't have this (around 0),
Correlation is tricky in QGIS, porbably bivariate map instead
-->

## Steps
1. Open Layer Properties of [Embeddings-2024 GeoPackage]{.orange}
2. Check out `Fields` - `population` (from ONS estimates)
<img src="assets/figures/lab1_exercise5_screen0.png" alt="screenshot" style="max-width:60%;" />

----

3. Calculate population density:
<div style="font-size: 0.7em;">

    - Open `Field Calculator`
    - Create a new field `popdens`
    - Put expression: `("population"/$area)*1000000`
    - Choose `Output field type` → `Integer (32 bit)`
    - Save changes
</div>

![](assets/figures/lab1_exercise5_screen1.png){ width=100% fig-alt="screenshot" fig-align="left" }

<!-- Processing Toolbox → Vector Analysis → Clustering Points -->

---- 

4. Statistical analysis
- Install [Plugins → Data Plotly]{.orange}
- Open DataPlotly and choose the layer with population density

::: {layout-ncol=2}
![](assets/figures/lab1_exercise5_screen2.png){width=40%}
:::

-----

::: {.columns}

::: {.column width="50%"}
5. Statistical analysis

    - Choose plot type → [Scatter Plot]{.orange}
    - X field: `A04_mean`, Y field: `popdens`
    - Change the `marker size` to 2 and stroke width to 1
    - Run `Create Plot`
:::


::: {.column width="50%"}
![](assets/figures/lab1_exercise5_screen3.jpg){width=100%}
:::

:::

----

6. Statistical analysis

    - Switch to the plot window
    - No obvious relationship?

![](assets/figures/lab1_exercise5_screen4.png){width=100%}

----

7. Statistical analysis
    - Switch back and clean plot canvas
    - Create the same scatter plot for `A08_mean` column
    - Can you see any relationship?


![](assets/figures/lab1_exercise5_screen5.png){width=100%}

----

Correlations?

![](assets/figures/lab1_populationdensity_correlation.png){ width=70% fig-alt="screenshot" fig-align="left" }

- Each band is [unique but weak alone]{.orange}
- We can't use just one dimension for analysis!

<!-- None of the bands cannot tell the whole story! -->
  

## Thanks, you were great! <br>
You will have another portion of exercises soon...

<!-- # Questions/TODOs
- Unsure if there is QGIS manipulation possible altogether with presentation slides...
- Maybe a short poll to rank the possible applications of embeddings (at the end)?
- To move speaker notes to the separate file -->

<!--## AUDIENCE POLL (after Lab 2):
Based on the today's workshop, just try to think of how Embeddings applications may be useful
for your routine and non-routine tasks. Rate them from 1 (not useful at all) to 5 (very useful): 
- spatial similarity search
- temporal similarity search
- unsupervised classification
- supervised classification
- clustering
- other (specify)-->



